name: Mirror Tasmota Release Build

on:
  schedule:
    - cron: '0 2 * * *'   # daily at 2:00 UTC
  workflow_dispatch:

permissions:
  contents: write  # Required to push tags and create releases
  
jobs:
  build:
    runs-on: ubuntu-latest
    name: Mirror Tasmota Tag & Build

    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # needed to fetch all tags

      # 2. Check Latest Tags
      - name: Check Latest Tags
        id: tags
        run: |
          # Latest Tasmota tag
          LATEST_TASMOTA=$(curl -s https://api.github.com/repos/arendst/Tasmota/releases/latest | jq -r '.tag_name')
          echo "LATEST_TASMOTA=$LATEST_TASMOTA" >> $GITHUB_ENV

          # My latest repo tag (or "none" if no tags)
          MY_LATEST="none"
          if git describe --tags --abbrev=0 >/dev/null 2>&1; then
            MY_LATEST=$(git describe --tags --abbrev=0)
          fi
          echo "MY_LATEST=$MY_LATEST" >> $GITHUB_ENV

          echo "Latest Tasmota tag: $LATEST_TASMOTA"
          echo "My latest tag: $MY_LATEST"

          # Decide if build needed
          if [ "$LATEST_TASMOTA" = "$MY_LATEST" ]; then
            echo "BUILD_NEEDED=false" >> $GITHUB_ENV
          else
            echo "BUILD_NEEDED=true" >> $GITHUB_ENV
          fi

      # 3. Clone Tasmota & Copy custom files (only if build needed)
      - name: Clone Tasmota & Copy custom files
        if: env.BUILD_NEEDED == 'true'
        run: |
          git clone --depth 1 --branch ${{ env.LATEST_TASMOTA }} https://github.com/arendst/Tasmota.git tasmotabuild

          cp platformio_override.ini tasmotabuild/platformio_override.ini
          cp tasmota/tasmota_xdrv_driver/xdrv_99_honey_wending.ino tasmotabuild/tasmota/tasmota_xdrv_driver/xdrv_99_honey_wending.ino

      # 4. Install DOX CLI (only if build needed)
      - name: Setup DOX CLI
        if: env.BUILD_NEEDED == 'true'
        uses: dopxlab/setup-dox-cli@v1

      # 5. Configure PlatformIO and build
      - name: Configure PlatformIO & Build
        if: env.BUILD_NEEDED == 'true'
        working-directory: tasmotabuild
        run: |
          dox config pio
          pio run -e tasmota32-beekeeper 
          cp .pio/build/tasmota32-beekeeper/firmware.bin tasmota32-beekeeper.bin
          cp .pio/build/tasmota32-beekeeper/firmware.factory.bin tasmota32-beekeeper.factory.bin
          gzip -k tasmota32-beekeeper.bin  # Creates tasmota32-beekeeper.bin.gz, keeps original

      # 6. Upload firmware artifact
      - name: Upload Firmware Artifact
        if: env.BUILD_NEEDED == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: beekeeper-firmware-${{ env.LATEST_TASMOTA }}
          path: |
            tasmotabuild/tasmota32-beekeeper.bin
            tasmotabuild/tasmota32-beekeeper.bin.gz
            tasmotabuild/tasmota32-beekeeper.factory.bin

      # 7. Create new tag matching Tasmota tag
      - name: Tag Repo with Tasmota Version
        if: env.BUILD_NEEDED == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git tag ${{ env.LATEST_TASMOTA }}
          git push origin ${{ env.LATEST_TASMOTA }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 8. Create GitHub Release with firmware files
      - name: Create Release
        if: env.BUILD_NEEDED == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.LATEST_TASMOTA }}
          name: Beekeeper ${{ env.LATEST_TASMOTA }}
          body: |
            Beekeeper firmware based on [Tasmota ${{ env.LATEST_TASMOTA }}](https://github.com/arendst/Tasmota/releases/tag/${{ env.LATEST_TASMOTA }})

            ## Firmware Files
            - **tasmota32-beekeeper.bin** – Standard firmware
            - **tasmota32-beekeeper.bin.gz** – Compressed OTA firmware
            - **tasmota32-beekeeper.factory.bin** – Factory flash image
          files: |
            tasmotabuild/tasmota32-beekeeper.bin
            tasmotabuild/tasmota32-beekeeper.bin.gz
            tasmotabuild/tasmota32-beekeeper.factory.bin
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
